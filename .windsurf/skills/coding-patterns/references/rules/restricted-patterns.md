# Restricted Patterns

Strictly forbidden patterns in the codebase. Violations will cause build failures, security issues, or platform incompatibility.

## Absolutely Forbidden Patterns

### 1. Locale Case Methods

```typescript
// ❌ FORBIDDEN
string.toLocaleLowerCase()
string.toLocaleUpperCase()

// ✅ CORRECT
string.toLowerCase()
string.toUpperCase()
```

**Why**: `toLocaleLowerCase()` and `toLocaleUpperCase()` behave inconsistently across platforms and locales, causing bugs in address validation, token matching, and other critical operations.

### 2. Direct Heavy Module Import

```typescript
// ❌ FORBIDDEN - Direct import of heavy modules
import { HeavyModule } from 'heavy-package';

// ✅ CORRECT - Use lazy loading
async function useHeavyModule() {
  const { HeavyModule } = await HeavyModuleLoader();
  // use HeavyModule
}
```

**Why**: Direct import causes bundle size issues and platform incompatibility. Lazy loaders handle platform-specific initialization.

### 3. Direct Instance Import (bypassing wrappers)

```typescript
// ❌ FORBIDDEN - Bypasses initialization checks
import { dbInstance } from '@{scope}/kit-bg/...';

// ✅ CORRECT - Use the wrapper
import { db } from '@{scope}/kit-bg/...';
```

**Why**: Direct instance imports bypass initialization checks. Always use wrappers which ensure proper initialization.

### 4. Modifying Auto-Generated Files

```typescript
// ❌ FORBIDDEN - Never edit auto-generated files
// Examples: translation files, generated types, etc.
```

**Why**: These files are auto-generated by build systems. Manual changes will be overwritten and may break pipelines.

### 5. Bypassing TypeScript Types

```typescript
// ❌ FORBIDDEN (without documented justification)
const value = something as any;
// @ts-ignore
const result = badCode();

// ✅ CORRECT - With documented justification
// @ts-expect-error - Legacy API returns unknown shape, validated at runtime
const legacyResult = legacyApi.call();
```

**Why**: Type safety is critical for a financial application. Every `any` or `@ts-ignore` is a potential runtime error.

### 6. Committing Failing Code

```bash
# ❌ FORBIDDEN
git commit  # with lint errors or TypeScript errors

# ✅ CORRECT - Full check
yarn lint:only  # Lint all files
yarn tsc:only   # Type check all files
git commit

# ✅ CORRECT - Fast pre-commit (recommended)
yarn lint:staged  # Only lint staged files
yarn tsc:staged   # Type check
git commit
```

**Why**: CI will fail, blocking other developers. Always verify locally before committing.

## Violation Consequences

| Violation | Consequence |
|-----------|-------------|
| Locale case methods | String comparison bugs, validation failures |
| Direct heavy module import | Bundle bloat, platform failures |
| Direct instance import | Initialization race conditions |
| Editing auto-generated files | Build failures, lost changes |
| Bypassing TypeScript | Runtime crashes, security vulnerabilities |
| Committing failing code | CI failures, blocked PRs, team productivity loss |

## Pre-Commit Checklist

Before every commit:

- [ ] No `toLocaleLowerCase()` or `toLocaleUpperCase()`
- [ ] No direct heavy module imports (use lazy loaders)
- [ ] No direct instance imports (use wrappers)
- [ ] No edits to auto-generated files
- [ ] No unjustified `any` or `@ts-ignore`
- [ ] `yarn lint:staged` passes
- [ ] `yarn tsc:staged` passes

**Note:** Full lint (`yarn lint`) runs in CI only.

## How to Fix Common Violations

### Fix: Locale Case Methods

```bash
# Find violations
grep -r "toLocaleLowerCase\|toLocaleUpperCase" packages/
```

```typescript
// Replace
- address.toLocaleLowerCase()
+ address.toLowerCase()
```

### Fix: Heavy Module Import

```typescript
// Replace direct import with lazy loader
- import { something } from 'heavy-package';
- const result = something();

+ const { something } = await HeavyModuleLoader();
+ const result = something();
```

### Fix: TypeScript Bypass

```typescript
// Instead of any, use proper types
- const data: any = response.data;
+ interface IResponseData { ... }
+ const data: IResponseData = response.data;

// Instead of @ts-ignore, use @ts-expect-error with explanation
- // @ts-ignore
+ // @ts-expect-error - Third-party library missing types, tracked in #1234
```
